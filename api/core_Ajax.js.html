<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from burner-docs.local/api/core_Ajax.js.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 09 Aug 2016 23:19:16 GMT -->
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/Ajax.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/Ajax.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * src/core/Ajax.js
 * Author: H.Alper Tuna &lt;halpertuna@gmail.com>
 * Date: 08.08.2016
 */

'use strict';

define([
    './Utils', './EventHandler'
], function(
    Utils, EventHandler
){
    function readyStateChange(){
        var xhttp = this.get('xhttp');
        if(xhttp.readyState == 4){
            //"always" closes connection and "success" may open new connection, so to prevent excessing maxConnection, always is at top of other triggers
            this.emit('always', xhttp.responseText);

            var fail = false;
            if(xhttp.status == 200){
                if(this.get('events').success.length){
                    var json;
                    try{
                        json = JSON.parse(xhttp.responseText);
                    }catch(e){
                        fail = true;
                    }
                    if(!fail)
                        this.emit('success', json);
                }
            }else fail = true;

            if(fail)
                this.emit('fail', xhttp.responseText);
        }
    }

    function parse(key, value, result){
        if(Utils.isArray(value)){
            key += '[]';
            for(var i in value)
                parse(key, value[i], result);
        }else if(Utils.isObject(value)){
            for(var i in value)
                parse(key + '[' + i + ']', value[i], result);
        }else
            result.push(encodeURIComponent(key) + '=' + encodeURIComponent(value));
    }

    function toParam(object){
        var result = [];

        for(var key in object){
            var value = object[key];
            parse(key, value, result)
        }

        return result.join('&amp;');
    }

    return EventHandler.extend(/** @lends core/Ajax# */{
        'connectionIsOpen': false,

        /**
         * Ajax component class.
         * @constructs
         * @param {string} url - Url address.
         * @augments ui/EventHandler
         */
        'init': function(url){
            /**
             * On send event.
             * @event core/Ajax.core/Ajax:send
             */
            /**
             * On respond is successful event.
             * @event core/Ajax.core/Ajax:success
             * @param {Object} Responded json object
             */
            /**
             * On respond is fail event.
             * @event core/Ajax.core/Ajax:fail
             * @param {string} Responded non-parsed text.
             */
            /**
             * On respond is got event.
             * @event core/Ajax.core/Ajax:always
             * @param {string} Responded non-parsed text.
             */
            /**
             * On reached maximum connection event.
             * @event core/Ajax.core/Ajax:maxConnection
             */
            this.handle('send');
            this.handle('success');
            this.handle('fail');
            this.handle('always');
            this.handle('maxConnection');

            this.on('send', this.set.bind(this, 'connectionIsOpen', true));
            this.on('always', this.set.bind(this, 'connectionIsOpen', false));

            //TODO debug tool
            this.on('fail', function(c){
                console.warn('Response for ajax has fail: "' + c + '"');
            });
            //TODO debug tool
            this.on('maxConnection', function(c){
                console.warn('Reached max connection.');
            });

            var xhttp;
            if(window.XMLHttpRequest)
                xhttp = new XMLHttpRequest();
            else
                //For IE6, IE5
                xhttp = new ActiveXObject("Microsoft.XMLHTTP");
            this.set('xhttp', xhttp);
            if(url)
                this.setUrl(url);
        },
        'method': 'POST',

        /**
         * Sets request method.
         * @param {string} method - Method name.
         * @return {Object} Instance reference.
         */
        'setMethod': function(method){
            this.set('method', method);
            return this.ref;
        },
        /**
         * Sets url address.
         * @param {string} method - Url address.
         * @return {Object} Instance reference.
         */
        'setUrl': function(url){
            this.set('url', url);
            return this.ref;
        },
        /**
         * Sends ajax request.
         * @param {Object} [object] - Request data.
         * @return {Object} Instance reference.
         * @fires core/Ajax.core/Ajax:maxConnection
         * @fires core/AjaxGroup.core/AjaxGroup:maxConnection
         * @fires core/AjaxGroup.core/AjaxGroup:openedConnection
         * @fires core/Ajax.core/Ajax:send
         */
        'send': function(object){
            if(this.get('connectionIsOpen')){
                console.warn('Last connection hasn\'t closed yet.');

                return this.ref;
            }

            var ajaxGroup = this.get('ajaxGroup');
            if(ajaxGroup){
                if(!ajaxGroup.hasRoom()){
                    this.emit('maxConnection');
                    ajaxGroup.emit('maxConnection');
                    return this.ref;
                }
                ajaxGroup.emit('openedConnection');
            }

            var xhttp = this.get('xhttp');
            var params = toParam(object);
            var method = this.get('method');
            var url = this.get('url');
            if(method == 'GET') url += '?' + params;
            xhttp.open(method, url, true);
            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhttp.onreadystatechange = readyStateChange.bind(this);
            if(!object || method == 'GET') xhttp.send();
            else xhttp.send(params);

            this.emit('send');

            return this.ref;
        },

        'bound': false,
        /**
         * Binds to an AjaxGroup to work with other Ajaxs.
         * @param {core/AjaxGroup} ajaxGroup - Ajax group to bind.
         * @return {Object} Instance reference.
         */
        'bind': function(ajaxGroup){
            if(this.get('bound')){
                //TODO error
                throw 'This ajax instance is already bound a group.';
                return this.ref;
            }

            this.set('bound', true);
            this.set('ajaxGroup', ajaxGroup);
            this.on('always', ajaxGroup.emit.bind(ajaxGroup, 'closedConnection'));
            return this.ref;
        }
    })
})
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index-2.html">Home</a></h2><h3>Classes</h3><ul><li><a href="core_Ajax.html">core/Ajax</a></li><li><a href="core_AjaxGroup.html">core/AjaxGroup</a></li><li><a href="core_createClass.html">core/createClass</a></li><li><a href="core_EventHandler.html">core/EventHandler</a></li><li><a href="core_Utils.html">core/Utils</a></li><li><a href="ui_Breadcrumb.html">ui/Breadcrumb</a></li><li><a href="ui_Button.html">ui/Button</a></li><li><a href="ui_Check.html">ui/Check</a></li><li><a href="ui_CheckGroup.html">ui/CheckGroup</a></li><li><a href="ui_ComponentContainer.html">ui/ComponentContainer</a></li><li><a href="ui_Document.html">ui/Document</a></li><li><a href="ui_Dropdown.html">ui/Dropdown</a></li><li><a href="ui_Element.html">ui/Element</a></li><li><a href="ui_Group.html">ui/Group</a></li><li><a href="ui_Icon.html">ui/Icon</a></li><li><a href="ui_Input.html">ui/Input</a></li><li><a href="ui_Label.html">ui/Label</a></li><li><a href="ui_List.html">ui/List</a></li><li><a href="ui_Message.html">ui/Message</a></li><li><a href="ui_Notifier.html">ui/Notifier</a></li><li><a href="ui_Popup.html">ui/Popup</a></li><li><a href="ui_RadioGroup.html">ui/RadioGroup</a></li><li><a href="ui_Spinner.html">ui/Spinner</a></li><li><a href="ui_Switch.html">ui/Switch</a></li><li><a href="ui_TextElement.html">ui/TextElement</a></li><li><a href="ui_Tip.html">ui/Tip</a></li></ul><h3>Events</h3><ul><li><a href="core_Ajax.html#.event:core/Ajax:always">core/Ajax:always</a></li><li><a href="core_Ajax.html#.event:core/Ajax:fail">core/Ajax:fail</a></li><li><a href="core_Ajax.html#.event:core/Ajax:maxConnection">core/Ajax:maxConnection</a></li><li><a href="core_Ajax.html#.event:core/Ajax:send">core/Ajax:send</a></li><li><a href="core_Ajax.html#.event:core/Ajax:success">core/Ajax:success</a></li><li><a href="core_AjaxGroup.html#.event:core/AjaxGroup:change">core/AjaxGroup:change</a></li><li><a href="core_AjaxGroup.html#.event:core/AjaxGroup:closedConnection">core/AjaxGroup:closedConnection</a></li><li><a href="core_AjaxGroup.html#.event:core/AjaxGroup:closedLastConnection">core/AjaxGroup:closedLastConnection</a></li><li><a href="core_AjaxGroup.html#.event:core/AjaxGroup:maxConnection">core/AjaxGroup:maxConnection</a></li><li><a href="core_AjaxGroup.html#.event:core/AjaxGroup:openedConnection">core/AjaxGroup:openedConnection</a></li><li><a href="core_AjaxGroup.html#.event:core/AjaxGroup:openedFirstConnection">core/AjaxGroup:openedFirstConnection</a></li><li><a href="ui_Button.html#.event:ui/Button:click">ui/Button:click</a></li><li><a href="ui_Check.html#.event:ui/Check:change">ui/Check:change</a></li><li><a href="ui_Check.html#.event:ui/Check:click">ui/Check:click</a></li><li><a href="ui_CheckGroup.html#.event:ui/CheckGroup:change">ui/CheckGroup:change</a></li><li><a href="ui_Dropdown.html#.event:ui/Dropdown:change">ui/Dropdown:change</a></li><li><a href="ui_Element.html#.event:ui/Element:hide">ui/Element:hide</a></li><li><a href="ui_Element.html#.event:ui/Element:show">ui/Element:show</a></li><li><a href="ui_Input.html#.event:ui/Input:change">ui/Input:change</a></li><li><a href="ui_List.html#.event:ui/List:change">ui/List:change</a></li><li><a href="ui_List.html#.event:ui/List:selectedInternally">ui/List:selectedInternally</a></li><li><a href="ui_RadioGroup.html#.event:ui/RadioGroup:change">ui/RadioGroup:change</a></li><li><a href="ui_Spinner.html#.event:ui/Spinner:change">ui/Spinner:change</a></li><li><a href="ui_Switch.html#.event:ui/Switch:change">ui/Switch:change</a></li><li><a href="ui_Switch.html#.event:ui/Switch:click">ui/Switch:click</a></li></ul><h3>Interfaces</h3><ul><li><a href="iComponent.html">iComponent</a></li><li><a href="iInput.html">iInput</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Aug 10 2016 01:17:51 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>

<!-- Mirrored from burner-docs.local/api/core_Ajax.js.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 09 Aug 2016 23:19:16 GMT -->
</html>
